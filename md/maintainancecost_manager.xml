<?xml version="1.0" encoding="UTF-8"?>
<mdscript name="Maintainancecost_manager" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="Maintainancecost_init">
      <conditions>
        <check_any>
          <event_game_loaded />
          <event_game_started />
        </check_any>
      </conditions>
      <actions>
        <!-- create global log of maintainance state -->
        <remove_value name="global.$maintainancecost_allships" />
        <create_group groupname="global.$maintainancecost_allships" />
        <!-- player black board, readable by lua -->
        <remove_value name="player.entity.$maintainancecost_states" />
        <set_value name="player.entity.$maintainancecost_states" exact="table[]" />
        <!-- find and register all existing ships: 1 brand new, 2 normal, 3 scratched, 4 junk -->
        <find_ship space="player.galaxy" groupname="global.$maintainancecost_allships" multiple="true" state="componentstate.operational" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]" unit="false" >
          <match owner="faction.khaak" negate="true" />
          <match owner="faction.xenon" negate="true" />
        </find_ship>
        <do_for_each name="$locship" in="global.$maintainancecost_allships">
          <set_value name="player.entity.$maintainancecost_states.{$locship}" exact="[1, 100]" />
        </do_for_each>
        <create_station name="global.$MtCst_dummybuilder" macro="macro.station_gen_factory_base_01_macro" owner="faction.criminal" state="componentstate.operational"  constructionplan="'maintainanceCost_dummybuilder'" sector="player.sector">
          <position x="100000km" y="100000km" z="100000km" />
        </create_station>
        <create_control_entity name="$manager" object="global.$MtCst_dummybuilder" post="controlpost.shiptrader">
          <select tags="controlpost.shiptrader.tag" />
          <owner exact="faction.argon" />
        </create_control_entity>
        <signal_cue cue="Maintainancecost_monitor" />
        <signal_cue cue="Maintainancecost_setdebug" />
        <!-- <signal_cue cue="Maintainancecost_coststatitics" /> -->
      </actions>
    </cue>


    <!-- occasionally go through the logs to clear out invalid ships-->
    <cue name="Maintainancecost_check" checktime="15min" >
      <delay min="5min" max="20min"/>
      <actions>
        <find_ship space="player.galaxy" groupname="global.$maintainancecost_allships" multiple="true" state="componentstate.operational" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]" unit="false" >
          <match owner="faction.khaak" negate="true" />
          <match owner="faction.xenon" negate="true" />
        </find_ship>
        <set_value name="$validships" exact="[]" />
        <append_list_elements name="$validships" group="global.$maintainancecost_allships" />
        <set_value name="$invalidships" exact="player.entity.$maintainancecost_states.keys.list" />
        <remove_from_list name="$invalidships" list="$validships" />
        <do_for_each in="$invalidships" name="$locship">
          <remove_value name="player.entity.$maintainancecost_states.{$locship}" />
        </do_for_each>
        <remove_value name="$invalidships" />
        <remove_value name="$validships" />
        <reset_cue cue="this" />
      </actions>
    </cue>


    <!-- engineer ai does registering new ships, so only listen to destroy -->
    <cue name="Maintainancecost_monitor" >
      <conditions>
        <event_cue_signalled />
      </conditions>
      <cues>
        <cue name="ClearOnDestroy" instantiate="true">
          <conditions>
            <event_object_destroyed group="global.$maintainancecost_allships" />
          </conditions>
          <actions>
            <remove_from_group group="global.$maintainancecost_allships" object="event.object" />
            <remove_value name="player.entity.$maintainancecost_states.{event.object}" />
          </actions>
        </cue>
      </cues>
    </cue>


    <cue name="Maintainancecost_setdebug">
      <conditions>
        <check_any>
          <event_game_loaded />
          <event_cue_signalled />
        </check_any>
      </conditions>
      <actions>
        <set_value name="global.$maintainancecost_debug" exact="100" />
        <reset_cue cue="this" />
      </actions>
    </cue>


    <cue name="Maintainancecost_coststatitics">
      <conditions>
        <event_cue_signalled />
      </conditions>
      <actions>
        <do_for_each name="$cls" in="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]">
          <!-- <set_value name="$totalware_ter" exact="table[
          {ware.computronicsubstrate}=0,
          {ware.siliconcarbide}=0,
          {ware.metallicmicrolattice}=0]" /> -->
          <set_value name="$totalware_gen" exact="table[
          {ware.advancedelectronics}=0,
          {ware.antimatterconverters}=0,
          {ware.engineparts}=0,
          {ware.shieldcomponents}=0,
          {ware.weaponcomponents}=0,
          {ware.hullparts}=0
          ]" />
          <find_ship space="player.galaxy" groupname="$ships" multiple="true" state="componentstate.operational" class="$cls" unit="false" >
            <match owner="faction.khaak" negate="true" />
            <match owner="faction.xenon" negate="true" />
            <match owner="faction.terran" negate="true" />
            <match owner="faction.player" negate="true" />
          </find_ship>
          <do_for_each name="$locship" in="$ships">
            <add_build_to_construct_ship object="global.$MtCst_dummybuilder" buildobject="$locship" result="$locbuild" />
            <set_value name="$wares" exact="global.$MtCst_dummybuilder.buildresources.{$locbuild}.table" />
            <remove_build build="$locbuild" object="global.$MtCst_dummybuilder" />
            <do_for_each in="$totalware_gen.keys.list" name="$w" >
              <do_if value="@$wares.{$w}">
                <set_value name="$totalware_gen.{$w}" operation="add" exact="$wares.{$w}" />
              </do_if>
            </do_for_each>
          </do_for_each>
          <do_for_each in="$totalware_gen.keys.list" name="$w" >
            <set_value name="$totalware_gen.{$w}" exact="($totalware_gen.{$w})f/($ships.count)f" />
          </do_for_each>
          <debug_text text="'To build a %s ship on averate one needs: %s'.[$cls, $totalware_gen]" filter="error" />
        </do_for_each>
      </actions>
    </cue>


  </cues>
</mdscript>